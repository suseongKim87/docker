# 베이스 만들기
docker의 이미지를 만들기 위해서 최소한의 os image를 다운로드 받아야 합니다. (centos, ubuntu etc...)  
예제에서는 centos를 기반으로 하고 있기 때문에 centos 7 을 기반으로 하도록 하겠습니다.  
사실 centos에서 docker project를 하기위해서 버전업 까지 하게되었습니다... linux 서버 설치 관련해서는 다음에 작성하도록 하겠습니다.  

## 1. centOS 7 이미지 다운로드
먼저 centos 7의 기본이 되는 docker hadoop base image를 만들기 위해서는 먼저 centos image를 다운 받아야 합니다.  
```{.text}
docker hub에 있는 centos 관련 이미지를 확인해 볼 수 있습니다.
$ docker search centos
NAME                               DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED
centos                             The official build of CentOS.                   5133                [OK]
ansible/centos7-ansible            Ansible on Centos7                              119                                     [OK]
...
```
아래와 같이 다운로드를 할 경우, CentOS의 offcial image를 다운로드 합니다.  
```{.text}
$ docker pull centos
```

## 2. docker centOS 7 접근하기
일단 다운로드 받은 centOS를 "docker run" 명령어를 통해 실행하고, "docker ps" 명령어로 실행 된 이미지를 확인 합니다.
```{text}
$ docker run -itd centos /bin/bash
dee37ed8d9042bc8f21f9ef97e20b48d103ad79010be67d674f17ced207680d2

$ docker ps
CONTAINER ID        IMAGE        COMMAND             CREATED             STATUS              PORTS              NAMES
dee37ed8d904        centos      "/bin/bash"       10 seconds ago      Up 9 seconds                         eloquent_ishizaka
```
실행된 container를 확인하고, 실행을 합니다. 실행은 "docker exec" 명령어를 통해 실행합니다.
```{text}
$ docker exec -it dee37ed8d904 /bin/bash
[root@dee37ed8d904 /]#
```

## 3. 실행 된 centOS 에서 계정을 생성 하고, yum update 및 필수 라이브러리 Install
centOS를 설치하고 yum을 최신 버전으로 업데이트 하고, 설치에 필요한 package를 install 합니다.  
```{text}
$ yum update
$ yum install -y curl openssh-server openssh-clients rsync wget net-tools rdate

```

## 4. open-jdk 설치 
open-jdk는 oracle-jdk의 유료화로 요즘 많은 개발자들이 옮겨가고 있는 추세입니다.  
우리는 지금까지 jdk를 돈내고 쓴적이 없고, open-jdk가 상용화에 문제가 없으니, jdk는 open-jdk로 진행하였습니다.  
```{text}
yum install -y java-1.8.0-openjdk-devel.x86_64
```

## 5. generate the SSH rsa key 생성  
서버간의 통신이 가능하게 공개키를 설정하기 위해서 아래와 같은 작업을 해줍니다. 
```{text}
$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Created directory '/root/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:9tyVXHZtMIA4XFpXAkmBRDmxr7SUcJxpVbs0G58uV4U root@af70f7e9c9ed
The key's randomart image is:
+---[RSA 2048]----+
|       ++BB*=o+  |
|       .BBo. o +.|
|      . Oo  = E B|
|       + o . B *o|
|        S . o * .|
|       + = . o . |
|        o o o o  |
|             o   |
|                 |
+----[SHA256]-----+
```
key 생성이 완료되면, key가 저장된 기본경로(.ssh)를 Permission 700, .ssh 하위 디렉토리에 Permission 600을 정의합니다.  
```{text}
$ chmod 700 /root/.ssh
$ chmod 600 /root/.ssh/*
$ cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
```
docker인 경우(systemctl 명령어 사용이 불가능 하기 때문에 /sbin/sshd 를 직접 실행해 줘야합니다.
```{text}
 /sbin/sshd <=== systemctl restart sshd.
Could not load host key: /etc/ssh/ssh_host_rsa_key
Could not load host key: /etc/ssh/ssh_host_ecdsa_key
Could not load host key: /etc/ssh/ssh_host_ed25519_key
sshd: no hostkeys available -- exiting.
```
이후, 위 3개의 파일에 ssh-keygen을 통해 해당경로에 key를 만들어 줍니다.  
```{text}  
$ ssh-keygen -q -N "" -t rsa -f /etc/ssh/ssh_host_rsa_key
$ ssh-keygen -q -N "" -t dsa -f /etc/ssh/ssh_host_dsa_key
$ ssh-keygen -q -N "" -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key
```  
마지막으로 모든 키 타입의 존재하지 않는 호스트 키를 생성해줍니다.
```{text}  
$ ssh-keygen -A(?)
ssh-keygen: generating new host keys: RSA1 ED25519
$ /sbin/sshd 
```

## 6. zookeeper 설치 및 설정
설치에 필요한 파일들은 다운로드 받기 위해서 wget을 설치 했으니, wget 명령어를 통해 다운로드를 해보도록 하겠습니다.  
```{text}
$ wget http://mirror.apache-kr.org/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz
```
다운로드 받은 파일을 풀어주고, 추가적 버전변경이 생길 수 있으므로 symbolic link를 통해 접근 할 수 있도록 합니다.
```{text}
$ tar -zxf zookeeper-3.4.13.tar.gz
$ mv zookeeper-3.4.13 /home/hduser/
$ ln -s /home/hduser/zookeeper-3.4.13 /home/hduser/zookeeper
```
이후, data, logs 폴더를 외부 폴더에 만들어 줍니다. 외부 폴더로 만들어 주는 이유는, docker volume 설정 때문입니다.  
container의 특징상 휘발성 데이터를 가지게 되므로, 외부와 연결되는 폴더를 만들어 데이터를 유지할 수 있도록 하기 위해서 입니다.  
자세한 내용은 다음챕터에서 hadoop을 실행할 때 설명하도록 하겠습니다.  
```{text}
$ ln -s /repository/zookeeper/data /home/hduser/zookeeper/data
$ ln -s /repository/zookeeper/logs /home/hduser/zookeeper/logs
```
다음은 zookeeper 설정파일 입니다. 저는 2대의 namenode(active, standby)를 설정해서 사용합니다.  
설정에서 중요한 점은 대부분의 클러스터를 구성 할 때처럼 선출이랑는 개념이 들어가서 홀수로 구성하는것이 원칙적으로 생각합니다.  
```{text}
$ cp /home/hduser/zookeeper/conf/zoo_sample.cfg /home/hduser/zookeeper/conf/zoo.cfg
$ vi zoo.cfg

*** zoo.cfg 설정 ***
# The number of milliseconds of each tick
tickTime=2000
# The number of ticks that the initial
# synchronization phase can take
initLimit=10
# The number of ticks that can pass between
# sending a request and getting an acknowledgement
syncLimit=5
# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just
# example sakes.
# dataDir=/tmp/zookeeper
# dataDir=/repository/zookeeper/data
dataDir=/home/hduser/zookeeper/data
# dataLogDir=/repository/zookeeper/logs
dataLogDir=/home/hduser/zookeeper/logs
# the port at which the clients will connect
clientPort=2181
# the maximum number of client connections.
# increase this if you need to handle more clients
# maxClientCnxns=60
#
# Be sure to read the maintenance section of the
# administrator guide before turning on autopurge.
#
# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance
#
# The number of snapshots to retain in dataDir
# autopurge.snapRetainCount=3
# Purge task interval in hours
# Set to "0" to disable auto purge feature
# autopurge.purgeInterval=1
server.1=master:2888:3888
server.2=standby:2888:3888
server.3=slave1:2888:3888
```

## 7. hadoop 설치 및 설정
위에서 zookeeper를 설치한 것처럼 wget 명령어를 통해 다운로드, 압축풀기, symbolic link, mount 작업을 실행합니다.  
```{text}
$ wget http://apache.tt.co.kr/hadoop/common/hadoop-3.1.1/hadoop-3.1.1.tar.gz
$ tar -zxf hadoop-3.1.1.tar.gz
$ mv hadoop-3.1.1 /home/hduser/ 
$ ln -s /home/hduser/hadoop-3.1.1 /home/hduser/hadoop
$ mkdir /repository/hadoop
$ mkdir /repository/hadoop/tmp /repository/hadoop/dfs /repository/hadoop/logs
$ ln -s /repository/hadoop/tmp /home/hduser/hadoop/tmp
$ ln -s /repository/hadoop/dfs /home/hduser/hadoop/dfs
$ ln -s /repository/hadoop/logs /home/hduser/hadoop/logs
```
위와 같이 작업을 통해 기본적이 hadoop 설치는 끝났습니다. 이후, 나머지 hadoop 설정을 진행합니다.  
hadoop 설정 작업은 "core-site.xml", "hdfs-site.xml", "mapred-site.xml", "yarn-site.xml"을 변경해 주면 됩니다.  
먼저 namenode의 설정파일인 "core-site.xml" 을 설정해 보도록 하겠습니다.  
(대부분은 기본값으로 hadoop 설정 되었습니다.)
```{text}
***core-site.xml***
<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<!--
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
-->

<!-- Put site-specific property overrides in this file. -->

<configuration>
    <property>
        <name>fs.defaultFS</name>
        <value>hdfs://hadoopcluster</value>
    </property>
    <property>
        <name>hadoop.tmp.dir</name>
        <value>/home/hduser/hadoop/tmp</value>
    </property>
    <property>
        <name>io.file.buffer.size</name>
        <value>4096</value>
    </property>
</configuration>
```  
